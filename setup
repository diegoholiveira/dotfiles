#!/usr/bin/env bash
# vim: ft=sh
DOTFILES_DIR=~/dotfiles
NODE_PKGS="eslint-plugin-jsx-a11y eslint-plugin-react"
NODE_PKGS="${NODE_PKGS} eslint-plugin-import eslint-config-airbnb eslint"
PACKAGES="ansible bash-completion git python nodejs npm"
PACKAGES="${PACKAGES} tree tmux stow go docker-compose"
PACKAGES="${PACKAGES} bash ssh-copy-id ruby pyenv pyenv-virtualenv"
PACKAGES="${PACKAGES} php71 php71-ast php71-intl composer php-code-sniffer"
STOW_FILES="bash git tmux vim eslint npm"
CASK_APPS="iterm2 firefox spotify java unrarx macvim"
CASK_APPS="${CASK_APPS} docker vagrant virtualbox sequel-pro sublime-text"

# Install Homebrew
if [ ! -f /usr/local/bin/brew ]; then
  ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"
  brew tap homebrew/dupes
  brew tap homebrew/versions
  brew tap homebrew/php
else
  brew update
fi

# Install Brew packages
for PACKAGE in $PACKAGES; do
  brew install $PACKAGE
done

# Install Cask apps
for APP in $CASK_APPS; do
  brew cask install $APP
done

# Install Brew packages
for PKG in $BREW_PKGS; do
  if brew list -1 | grep -q "^${PKG}\$"; then
    brew upgrade $PKG
  else
    brew install $PKG
  fi
done

# Install vim replace macos defaults
brew install vim --with-override-system-vi --with-python3

# Upgrade pip and setuptools
pip install --upgrade pip setuptools

# Import iTerm2 configs
defaults import com.googlecode.iterm2 ${DOTFILES_DIR}/iterm2.plist

# Add the new shell to the list of allowed shells
grep -q "/usr/local/bin/bash" /etc/shells
if [ $? -ne 0 ]; then
  sudo bash -c 'echo /usr/local/bin/bash >> /etc/shells'
fi

# change to the new shell
if [ "$SHELL" == "/bin/bash" ]; then
  chsh -s /usr/local/bin/bash
fi
# Clone the repository into the dotfiles dir
if [ ! -d $DOTFILES_DIR ]; then
  git clone https://github.com/diegoholiveira/dotfiles.git $DOTFILES_DIR
fi

# Remove the previous Bash profile
rm -f ~/.bash_profile ~/.bashrc

# Link the profiles to my versions
for APP in $STOW_FILES; do
  stow --dir=${DOTFILES_DIR} ${APP}
done

# Setup vim
. $DOTFILES_DIR/setup-vim

# Start using the new bash profile
. ~/.bash_profile

# Install global packages using NPM
for PKG in $NODE_PKGS; do
  npm -g ls ${PKG} > /dev/null 2>&1
  if [ "$?" == "1" ]; then
    npm -g install ${PKG}
  fi
done

# Install composer packages
for PACKAGE in $COMPOSER_PACKAGES; do
  composer global require "${PACKAGE}"
done

. $DOTFILES_DIR/setup-powerline-fonts

# Generates a ssh key for my user
if [ ! -f ~/.ssh/id_rsa ]; then
  ssh-keygen -t rsa -b 4096 -C "contato@diegoholiveira.com" -N "" -f ~/.ssh/id_rsa -q
fi

echo "------------------------------------------------------------------------------"
echo "Final instructions"
echo "------------------------------------------------------------------------------"
echo ""
echo "To secure your ssh key, please add a passphrase to it using the command above:"
echo "    ssh-keygen -p -f ~/.ssh/id_rsa"
echo ""
echo "Before start using the computer, please restart the SO to reload all changes"
echo "made by this script!"
echo ""

