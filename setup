#!/usr/bin/env bash
# vim: ft=sh
IFS=$'\n\t'

DOTFILES_DIR=~/dotfiles
STOW_FILES=("bash" "git" "npm" "ssh" "tmux" "vim")
TERMINAL_PREFERENCES="/Users/${USER}/Library/Preferences/com.apple.Terminal.plist"
TMUX_PLUGIN_MANAGER_DIR=~/.tmux/plugins/tpm

# Install Homebrew
if [ ! -f /usr/local/bin/brew ]; then
  ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"

  brew tap homebrew/bundle
fi

# Clone the repository into the dotfiles dir
if [ ! -d $DOTFILES_DIR ]; then
  git clone https://github.com/diegoholiveira/dotfiles.git $DOTFILES_DIR
fi

# Configure nord-dircolors
if [ ! -f ~/.dir_colors ]; then
  curl -sSkLo ~/.dir_colors https://raw.githubusercontent.com/arcticicestudio/nord-dircolors/develop/src/dir_colors
fi

# Install my terminal preferences
cp $DOTFILES_DIR/com.apple.Terminal.plist $TERMINAL_PREFERENCES

# Install all dependencies using the Brewfile
(
  sudo mkdir -p /usr/local/sbin || true
  sudo chown "$USER:admin" /usr/local/sbin || true

  cd $DOTFILES_DIR || exit 1
  echo 'Installing dependencies using brew...'

  brew bundle > /dev/null
)

# Install IBM Plex (font-family)
(
  if [ ! -f /Library/Fonts/IBMPlexMono-Text.otf ]; then
    curl -sSkLo fonts.zip https://raw.githubusercontent.com/ibm/type/master/ibm-plex.zip
    unzip fonts.zip
    cp fonts/Mono/desktop/mac/*.otf /Library/Fonts/
    rm -rf fonts fonts.zip
  fi
)

# Add the new shell to the list of allowed shells
if ! grep -q "/usr/local/bin/bash" /etc/shells; then
  sudo bash -c 'echo /usr/local/bin/bash >> /etc/shells'
fi

# change to the new shell
if [ "$SHELL" == "/bin/bash" ]; then
  chsh -s /usr/local/bin/bash
fi

# Disable Java in Safari
defaults write com.apple.Safari \
  com.apple.Safari.ContentPageGroupIdentifier.WebKit2JavaEnabled \
  -bool false
defaults write com.apple.Safari \
  com.apple.Safari.ContentPageGroupIdentifier.WebKit2JavaEnabledForLocalFiles \
  -bool false

# Lock the computer when init the screensaver
defaults write com.apple.screensaver askForPassword -int 1
defaults write com.apple.screensaver askForPasswordDelay -int 0

# Link the profiles to my versions
rm -f ~/.npmrc
(
  cd $DOTFILES_DIR || exit 1
  for APP in "${STOW_FILES[@]}"; do
    stow "${APP}"
  done
)

. ~/.bashrc

# install pip packages
echo 'Installing python packages using pip...'
pip install --upgrade pip setuptools wheel > /dev/null
pip install \
  flake8 \
  pycodestyle \
  vim-vint \
  > /dev/null

# Generates a ssh key for my user
if [ ! -f ~/.ssh/id_rsa ]; then
  ssh-keygen -t rsa -b 4096 -C "contato@diegoholiveira.com" -N "" -f ~/.ssh/id_rsa -q

  echo "------------------------------------------------------------------------------"
  echo "Final instructions"
  echo "------------------------------------------------------------------------------"
  echo ""
  echo "To secure your ssh key, please add a passphrase to it using the command above:"
  echo "    ssh-keygen -p -f ~/.ssh/id_rsa"
  echo ""
  echo "Before start using the computer, please restart the SO to reload all changes"
  echo "made by this script!"
  echo ""
fi
