#!/usr/bin/env bash
# vim: ft=sh
IFS=$'\n\t'

BREW_PACKAGES=(
  "ansible" "bash" "bash-completion"
  "docker" "docker-compose" "exa" "flake8" "git" "go"
  "nodejs" "pass" "pyenv" "pyenv-virtualenv"
  "python" "ruby" "ssh-copy-id"
  "stow" "tig" "tmux"
)
CASK_PACKAGES=(
  "docker" "firefox" "iterm2" "java"
  "macvim" "sequel-pro" "spotify"
  "sublime-text" "unrarx" "vagrant"
  "virtualbox" "vlc"
)
DOTFILES_DIR=~/dotfiles
POWERLINE_FONTS_FILE=~/.powerline-fonts-installed
STOW_FILES=("bash" "git" "npm" "tmux" "vim")

# Install Homebrew
if [ ! -f /usr/local/bin/brew ]; then
  ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"
fi

# Install Cask apps
for PACKAGE in ${CASK_PACKAGES[@]}; do
  INSTALLED=$(brew cask list -1 | grep "^${PACKAGE}\$" || true)
  if [ "$INSTALLED" != "$PACKAGE" ]; then
    brew cask install $PACKAGE
  fi
done

# Install Brew packages
for PACKAGE in ${BREW_PACKAGES[@]}; do
  INSTALLED=$(brew list -1 | grep "^${PACKAGE}\$" || true)
  if [ "$INSTALLED" != "$PACKAGE" ]; then
    brew install $PACKAGE
  fi
done

# Install vim replace MacOS defaults
INSTALLED=$(brew list -1 | grep "^vim\$" || true)
if [ "$INSTALLED" != "vim" ]; then
  brew install vim --with-override-system-vi --with-python3
fi

# Upgrade all installed packages
brew upgrade

# Upgrade pip and setuptools
pip install --upgrade pip setuptools

# Add the new shell to the list of allowed shells
grep -q "/usr/local/bin/bash" /etc/shells
if [ $? -ne 0 ]; then
  sudo bash -c 'echo /usr/local/bin/bash >> /etc/shells'
fi

# change to the new shell
if [ "$SHELL" == "/bin/bash" ]; then
  chsh -s /usr/local/bin/bash
fi

# Clone the repository into the dotfiles dir
if [ ! -d $DOTFILES_DIR ]; then
  git clone https://github.com/diegoholiveira/dotfiles.git $DOTFILES_DIR
fi

# Import iTerm2 configs
defaults import com.googlecode.iterm2 ${DOTFILES_DIR}/iterm2.plist

# Remove the previous Bash profile
rm -f ~/.bash_profile ~/.bashrc

# Link the profiles to my versions
for APP in ${STOW_FILES[@]}; do
  stow --dir=${DOTFILES_DIR} ${APP}
done

# Setup powerline fonts
if [ ! -f $POWERLINE_FONTS_FILE ]; then
  git clone https://github.com/powerline/fonts.git
  cd fonts
  ./install.sh
  cd ..
  rm -rf fonts
  touch $POWERLINE_FONTS_FILE
fi

# Generates a ssh key for my user
if [ ! -f ~/.ssh/id_rsa ]; then
  ssh-keygen -t rsa -b 4096 -C "contato@diegoholiveira.com" -N "" -f ~/.ssh/id_rsa -q
fi

echo "------------------------------------------------------------------------------"
echo "Final instructions"
echo "------------------------------------------------------------------------------"
echo ""
echo "To secure your ssh key, please add a passphrase to it using the command above:"
echo "    ssh-keygen -p -f ~/.ssh/id_rsa"
echo ""
echo "Before start using the computer, please restart the SO to reload all changes"
echo "made by this script!"
echo ""
